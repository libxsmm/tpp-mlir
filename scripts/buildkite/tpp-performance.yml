env:
  # Required environment to call this script
  #  - TPPROOT
  #  - BUILD_DIR
  #  - SRUN
  LLVMROOT: "${TPPROOT}/llvm"
  NPROCS_LIMIT_LINK: "8"
  #LIBXSMM_VERBOSE: 4
  #LIBXSMMFETCH: 1

steps:
  - label: "LLVM"
    command: "scripts/buildkite/check_llvm.sh"
  - wait

  - label: "TPP-MLIR-performance"
    command:
      - "${SRUN} --partition=clxtrb --time=1:30:00 -- 'KIND=Release COMPILER=clang LINKER=lld scripts/buildkite/benchmark.sh'";
        # absolute path but symlinks not resolved (-P), mount point is different on head/compute node, upload even if failure
        buildkite-agent artifact upload \
            "$(cd "$${BUILDKITE_BUILD_PATH}/../artifacts/${BUILDKITE_PIPELINE_SLUG}/$${BUILDKITE_BUILD_NUMBER}" && pwd)/*"
    env:
      LOGRPTSUM: "mlir"
      LOGRPTBND: "-"
      LOGRPTQRY: ""
      LOGRPTSEP: 1
